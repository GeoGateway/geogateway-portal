<!DOCTYPE html>
<html lang="en" ng-app="UserProjectApp">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">    
    
    <!-- Latest compiled and minified CSS -->
    <link rel="shortcut icon" href="images/favicon/favicon.ico">
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <link rel="stylesheet" type="text/css" href="bower_components/qtip2/jquery.qtip.min.css"/>
    <link rel="stylesheet" href="bower_components/jquery-ui/themes/smoothness/jquery-ui.css"/>
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/qtip2/jquery.qtip.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/angular-route/angular-route.js"></script>
    <script src="bower_components/angular-cookies/angular-cookies.js"></script>


    <script type="text/javascript" src="https://cdn.auth0.com/js/lock-7.js"></script>
    <script src="//cdn.rawgit.com/auth0/angular-storage/master/dist/angular-storage.js" type="text/javascript"> </script>
    <script src="//cdn.rawgit.com/auth0/angular-jwt/master/dist/angular-jwt.js" type="text/javascript"> </script>
    <script type="text/javascript" src="https://cdn.auth0.com/w2/auth0-angular-4.js"></script>
    
    <!--GoogleMaps -->
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=drawing"></script>
    
    <!--Local libraries -->
    <script type="text/javascript" src="js/wms.js"></script>
    <script src="js/tools.js"></script>
    <script src="js/services.js"></script>
    <script src="js/controllers.js"></script>

    <!-- dygraphs -->
    <script type="text/javascript" src="js/dygraph-combined.js"></script>
    
    <!-- ajaxForm jquery plugin -->
    <script src="http://malsup.github.com/jquery.form.js"></script>
  </head>
  <body>
    <script>
      var gpsUrl="http://gf9.ucs.indiana.edu/daily_rdahmmexec/daily/UNAVCO_NUCLEUS_FILL.json";
      var gpsNetwork;
      var gspStations;
	   var iconDefImgUrl = "http://maps.google.com/mapfiles/ms/micons/green.png"; 
	   var iconSize = new google.maps.Size(18, 18);
	   var iconAnchor = new google.maps.Point(1, 10);
	   var iconOrigin = new google.maps.Point(0, 0);
      var icon=new google.maps.MarkerImage(iconDefImgUrl, iconSize, iconOrigin, iconAnchor, iconSize);
      var marker=[];
      

      $.getJSON(gpsUrl, function(){
         console.log("Started");
      })
      .done(function(data) {
        gpsNetwork=data;
        console.log("Done");
        console.log(gpsNetwork.Filters);
        console.log("Center latitude:"+gpsNetwork.center_latitude);
        gpsStations=gpsNetwork.stations;

        $.each(gpsStations, function(i, gpsStation) {
//          console.log(gpsStation.lat,gpsStation.long);
           var myLatLng=new google.maps.LatLng(gpsStation.lat,gpsStation.long);
           
           marker=new google.maps.Marker({
                position:myLatLng,
                icon: icon,
                clickable: true,
                title:gpsStation.id,
                map:mapA
             });
           
            marker.addListener('click',function(){
                  var dygraphsHtml="<html><body>";
		            dygraphsHtml+="<div><b>Data Set:</b> "+gpsNetwork.data_source+"<br/><b>Station ID:</b> "+gpsStation.id+" <b>Lat:</b> "+(new Number(gpsStation.lat)).toFixed(5)+" <b>Lon:</b> "+(new Number(gpsStation.long)).toFixed(5)+"<\/div>";
		           dygraphsHtml+="Click and drag to zoom plots vertically or horizontally.  Double-click the plot to reset to the default zoom level.";
		            dygraphsHtml+="<br/>";
                  dygraphsHtml+="<script src='http://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.0/dygraph-combined.js'>";
		            dygraphsHtml+="<\/script>";
		            dygraphsHtml+="<script src='"+gpsNetwork.server_url+"/"+gpsStation.pro_dir+"/"+gpsStation.DygraphsInputFile+"'><\/script>";
		            dygraphsHtml+="<script src='http://dygraphs.com/tests/data.js'><\/script>";
		            dygraphsHtml+="<div id='plotDiv1' style='width:800px;height:200px'><\/div>";
		            dygraphsHtml+="<br/>";
		            dygraphsHtml+="<div id='plotDiv2' style='width:800px;height:200px'><\/div>";
		            dygraphsHtml+="<br/>";
		            dygraphsHtml+="<div id='plotDiv3' style='width:800px;height:200px'><\/div>";
		            //Use mm displacements for UNAVCO data types.  Note significant figures change from below
		            dygraphsHtml+="<script type='text/javascript'>";
		            dygraphsHtml+="var graphs=[]\;"
		            dygraphsHtml+="var plot1, plot2, plot3\;";
		            if(gpsNetwork.data_source=='unavcoPboFill' || gpsNetwork.data_source=='unavcoNucleusFill') {
		                 dygraphsHtml+="plot1=new Dygraph(document.getElementById('plotDiv1'),data_east_disp,{drawPoints:true, strokeWidth:0.0, zoomCallback:zoomCallback, title:\"East Displacement (m)\",yAxisLabelWidth:150,sigFigs:4})\;";
		                 dygraphsHtml+="plot2=new Dygraph(document.getElementById('plotDiv2'),data_north_disp,{drawPoints:true, strokeWidth:0.0, zoomCallback:zoomCallback, title:\"North Displacement (m)\",yAxisLabelWidth:150,sigFigs:4})\;";
		                 dygraphsHtml+="plot3=new Dygraph(document.getElementById('plotDiv3'),data_up_disp,{drawPoints:true, strokeWidth:0.0, zoomCallback:zoomCallback, title:\"Height Displacement (m)\", yAxisLabelWidth:150,sigFigs:4})\;";
		          }
		        else {
		          //The other cases
			       dygraphsHtml+="plot1=new Dygraph(document.getElementById('plotDiv1'),data_east,{drawPoints:true, strokeWidth:0.0, zoomCallback:zoomCallback, title:\"North Displacement (mm)\",yAxisLabelWidth:100,sigFigs:3})\;";
			       dygraphsHtml+="plot2=new Dygraph(document.getElementById('plotDiv2'),data_north,{drawPoints:true, strokeWidth:0.0, zoomCallback:zoomCallback, title:\"East Displacement (mm)\",yAxisLabelWidth:100,sigFigs:3})\;";
			       dygraphsHtml+="plot3=new Dygraph(document.getElementById('plotDiv3'),data_up,{drawPoints:true, strokeWidth:0.0, zoomCallback:zoomCallback, title:\"Height (mm)\", yAxisLabelWidth:100,sigFigs:3})\;";
		         }
		         dygraphsHtml+="graphs.push(plot1)\;";
		         dygraphsHtml+="graphs.push(plot2)\;";
		         dygraphsHtml+="graphs.push(plot3)\;";
		         dygraphsHtml+="function zoomCallback(minDate,maxDate){for (var i=0\;i<graphs.length\;i++){graphs[i].updateOptions({dateWindow:[minDate,maxDate]})}}\;";
		dygraphsHtml+="<\/script>";

                  dygraphsHtml+="</body></html>";
      
             	   var windowName=gpsStation.id+"-Dygraphs";
		            var newWin = window.open("", windowName, "width=850,height=750");
		            newWin.document.writeln(dygraphsHtml);
		            newWin.document.title = gpsStation.id;
		            newWin.document.close();
            });

        });
      })
      .fail(function(data){
      console.log("Failed:");
      console.log(data);
      })
      .always(function(){
         console.log("Completed one way or the other");
      });


    </script>
    <div id="map-canvas"></div>
  </body>
</html>
